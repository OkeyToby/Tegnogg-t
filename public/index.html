<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Klassens Skribbl ‚Äì Hold</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root { --bg:#0b1324; --card:#111827; --muted:#9ca3af; --border:#1f2937; --ink:#111827; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; background: var(--bg); color: #fff; }
    header { padding:12px 16px; background: var(--card); display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); gap:10px; }
    #roomArea { display:flex; align-items:center; gap:8px; }
    main { display:grid; grid-template-columns: 320px 1fr 320px; gap:12px; padding:12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    h3 { margin-top:0; }
    #players .player { padding:6px 8px; border-radius:10px; background:#0f172a; margin-bottom:6px; display:flex; justify-content:space-between; }
    #canvas { background:#fff; border-radius:12px; touch-action:none; width:100%; height:auto; }
    button { border:0; border-radius:10px; padding:10px 14px; background:#0ea5e9; color:#fff; font-weight:700; cursor:pointer }
    input, .code { border:1px solid #374151; border-radius:10px; padding:10px 12px; background:#0f172a; color:#e5e7eb; width:100%; }
    input, select, .code { border:1px solid #374151; border-radius:10px; padding:10px 12px; background:#0f172a; color:#e5e7eb; width:100%; }
    #chooseModal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9999; }
    #chooseModal .inner { background:#fff; color:#111827; padding:18px; border-radius:14px; width:min(420px,92vw) }
    .wordopt { display:inline-block; margin:6px 6px 0 0; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; cursor:pointer; background:#f8fafc; }
    .wordopt { display:inline-block; margin:6px 6px 0 0; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; cursor:pointer; background:#f8fafc; color:#111827; }
    #chat { height: 52vh; overflow:auto; background:#0f172a; padding:8px; border-radius:10px; }
    .row { display:flex; gap:8px; }
    .muted { color: var(--muted); font-size:.95rem; }
    #podiumModal { position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:10000; }
    #podiumModal .inner { background:#111827; color:#fff; padding:22px; border-radius:16px; width:min(520px,94vw); text-align:center; border:1px solid #1f2937; }
    .podium { display:flex; align-items:flex-end; justify-content:center; gap:12px; margin-top:14px; }
    .pod { background:#0f172a; border:1px solid #1f2937; border-radius:12px; width:30%; padding:10px; }
    .pod.gold { background:#365314; } .pod.silver{ background:#334155 } .pod.bronze{ background:#3f1f0e }
    .toolrow { display:flex; gap:8px; align-items:center; margin-top:8px }
    .toolrow button { padding:8px 10px }
    .toolrow input[type=range]{ width:120px }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } header{flex-direction:column; align-items:flex-start;} }
  </style>
</head>
<body>
<header>
  <div>Klassens Skribbl ‚Äì Hold</div>
  <div id="roomArea">
    <div id="roomBadge" class="muted"></div>
    <button id="shareBtn" title="Del hold" style="display:none;background:#22c55e">Del</button>
    <button id="copyBtn" title="Kopi√©r holdkode" style="display:none;background:#64748b">Kopi√©r</button>
  </div>
</header>

<div id="login" class="card" style="margin:12px">
  <h3>Login</h3>
  <label>Navn</label>
  <input id="name" placeholder="Fornavn" />
  <br>
  <label>Avatar</label>
  <select id="avatar">
    <option value="üòÄ">üòÄ</option>
    <option value="üòé">üòé</option>
    <option value="üê±">üê±</option>
    <option value="üêª">üêª</option>
    <option value="ü¶ä">ü¶ä</option>
  </select>
  <br>
  <label>Klassekode</label>
  <input id="code" type="password" placeholder="Klassekode (fra l√¶rer)" />
  <br>
  <div class="row">
    <button id="btnCreate" style="flex:0 0 auto">Opret hold</button>
    <input id="roomIn" class="code" placeholder="Holdkode (join)" style="flex:1" />
    <button id="btnJoin" style="flex:0 0 auto">Join hold</button>
  </div>
  <p id="loginMsg" style="color:#fca5a5; margin:8px 0 0 0;"></p>
</div>

<main id="app" style="display:none">
  <section class="card" id="left">
    <h3>Spillere</h3>
    <div id="players"></div>
    <div id="hostCtl" style="margin-top:8px; display:none">
      <button id="startBtn">Start spil</button>
      <button id="restartBtn" style="background:#22c55e">Start nyt spil</button>
      <p class="muted" style="margin-top:6px">1 runde = alle har tegnet √©n gang.</p>
      <div id="roundCtl" style="margin-top:8px; display:none">
        <label>Runder: </label>
        <input id="roundsInput" type="number" min="1" value="1" style="width:60px">
        <button id="setRoundsBtn">S√¶t runder</button>
      </div>
    </div>
  </section>

  <section class="card" id="center">
    <canvas id="canvas" width="900" height="600" aria-label="Tegneomr√•de"></canvas>
    <div class="toolrow">
      <button id="penBtn" title="Pen">Pen</button>
      <button id="eraserBtn" title="Viskel√¶der" style="background:#f97316">Viskel√¶der</button>
      <label>Streg:</label>
      <input id="sizeRange" type="range" min="2" max="24" value="4">
      <button id="clearBtn" title="Ryd l√¶rred" style="background:#ef4444">Ryd</button>
    </div>
  </section>

  <section class="card" id="right">
    <h3>Chat & G√¶t</h3>
    <div id="chat" aria-live="polite"></div>
    <div class="row" style="margin-top:8px">
      <input id="msg" placeholder="Skriv g√¶t‚Ä¶" aria-label="Skriv g√¶t" />
      <button id="send">Send</button>
    </div>
    <div id="palette" class="row" style="margin-top:8px">
      <button data-color="#111827" style="background:#111827;width:24px;height:24px;border-radius:4px"></button>
      <button data-color="#ef4444" style="background:#ef4444;width:24px;height:24px;border-radius:4px"></button>
      <button data-color="#10b981" style="background:#10b981;width:24px;height:24px;border-radius:4px"></button>
      <button data-color="#3b82f6" style="background:#3b82f6;width:24px;height:24px;border-radius:4px"></button>
      <button data-color="#f59e0b" style="background:#f59e0b;width:24px;height:24px;border-radius:4px"></button>
      <button data-color="#a855f7" style="background:#a855f7;width:24px;height:24px;border-radius:4px"></button>
    </div>
    <div id="timer" class="muted" style="margin-top:6px"></div>
    <div id="phase" class="muted" style="margin-top:6px"></div>
  </section>
</main>

<div id="chooseModal">
  <div class="inner">
    <h3>V√¶lg eller skriv et ord</h3>
    <p class="muted" id="chooseHint">Maks 20 tegn ‚Äì tydeligt og fair for klassen.</p>
    <div id="options"></div>
    <div style="margin-top:10px">
      <input id="freeWord" placeholder="Skriv dit ord" />
      <div class="row" style="margin-top:8px">
        <button id="submitWord" class="wordopt">Brug mit ord</button>
        <button id="cancelWord" class="wordopt">Luk</button>
      </div>
    </div>
  </div>
</div>

<div id="podiumModal">
  <div class="inner">
    <h3>Podium</h3>
    <div id="podiumList" class="podium"></div>
     <div style="margin-top:10px">
      <button id="closePodium">Luk</button>
    </div>
  </div>
</div>

<script>
let socket;
let roomId = null, isHost = false, myId = null, myName = "";
let canDraw = false;
let currentColor = '#111827';
let chooseTimerInt = null;
let drawTimerInt = null;
let isErasing = false;
let brushSize = 4;

const $ = (id) => document.getElementById(id);
function addChat(text) {
  const c = $('chat'); const p = document.createElement('div'); p.textContent = text;
  c.appendChild(p); c.scrollTop = c.scrollHeight;
}
function renderPlayers(players) {
  const box = $('players'); box.innerHTML = "";
  players.forEach(p => {
    const d = document.createElement('div'); d.className = 'player';
    const info = document.createElement('span');
    const av = document.createElement('span'); av.textContent = p.avatar || ''; av.style.marginRight = '6px';
    const n = document.createElement('span'); n.textContent = p.name;
    info.appendChild(av); info.appendChild(n);
    const s = document.createElement('span'); s.textContent = p.score;
    d.appendChild(n); d.appendChild(s); box.appendChild(d);
    d.appendChild(info); d.appendChild(s); box.appendChild(d);
  });
}

function setupCanvas(){
  const cv = $('canvas');
  const ctx = cv.getContext('2d');
  ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=brushSize; ctx.strokeStyle=currentColor;
  let drawing=false, last=null;

  const drawSeg=(a,b,erase,color,size)=>{
    ctx.save();
    if(erase){ ctx.globalCompositeOperation='destination-out'; ctx.lineWidth=size||18; }
    else { ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=color||currentColor; ctx.lineWidth=size||brushSize; }
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
    ctx.restore();
  };
  const sendStroke=(a,b)=>{
    if(!canDraw) return;
    const payload = isErasing
      ? { a, b, erase:true, size: Math.max(brushSize*3, 12) }
      : { a, b, color: currentColor, size: brushSize };
    socket.emit('drawStroke',{roomId, stroke: payload});
    drawSeg(a,b, payload.erase, payload.color, payload.size);
  };

  const getPos = (e)=>{
    const r=cv.getBoundingClientRect();
    const src = e.touches ? e.touches[0] : e;
    const x = (src.clientX - r.left) * (cv.width / r.width);
    const y = (src.clientY - r.top ) * (cv.height / r.height);
    return {x,y};
  };

  cv.addEventListener('mousedown', e=>{ if(!canDraw) return; drawing=true; last=getPos(e); });
  cv.addEventListener('mousemove', e=>{
    if(!drawing) return;
    const pos=getPos(e); sendStroke(last,pos); last=pos;
  });
  window.addEventListener('mouseup', ()=> drawing=false);

  cv.addEventListener('touchstart', e=>{ if(!canDraw) return; drawing=true; last=getPos(e); });
  cv.addEventListener('touchmove', e=>{
    if(!drawing) return;
    const pos=getPos(e); sendStroke(last,pos); last=pos; e.preventDefault();
  }, {passive:false});
  window.addEventListener('touchend', ()=> drawing=false);

  socket.on('drawStroke', data => {
    const {a,b,color,erase,size} = data;
    drawSeg(a,b,erase,color,size);
  });

  $('penBtn').onclick = ()=>{ isErasing=false; };
  $('eraserBtn').onclick = ()=>{ isErasing=true; };
  $('sizeRange').oninput = (e)=>{ brushSize = parseInt(e.target.value||"4",10); };
  $('clearBtn').onclick = ()=>{
    if(!canDraw) return;
    const cv = $('canvas'); cv.getContext('2d').clearRect(0,0,cv.width,cv.height);
    // broadcast en stor "erase" ved at t√∏mme ‚Äì valgfrit: kunne ogs√• sende s√¶r-event til server
  };
}

$('btnCreate').onclick = ()=>{
  connect(()=>{
    socket.emit('createHold', (res)=>{
      if(!res.ok) return setLoginMsg(res.error||'Fejl.');
      ({roomId, isHost} = res); myId = socket.id; postJoin(res.players);
      updateShareUI();
      history.replaceState({}, "", addRoomToUrl(roomId));
    });
  });
};

$('btnJoin').onclick = ()=>{
  const rid = (($('roomIn').value||"").trim().toUpperCase());
  if(!rid) return setLoginMsg("Skriv en holdkode.");
  connect(()=>{
    socket.emit('joinHold', {roomId: rid}, (res)=>{
      if(!res.ok) return setLoginMsg(res.error||'Fejl.');
      roomId = rid; isHost = res.isHost; myId = socket.id; postJoin(res.players);
      updateShareUI();
      history.replaceState({}, "", addRoomToUrl(roomId));
    });
  });
};

$('send').onclick = sendGuess;
$('msg').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); sendGuess(); }
});

function sendGuess(){
  const m = $('msg'); const t = (m.value||"").trim();
  if(!t) return;
  socket.emit('guess', {roomId, msg:t});
  m.value="";
}

$('startBtn').onclick  = ()=> socket.emit('startGame',   {roomId});
$('restartBtn').onclick= ()=> socket.emit('restartGame', {roomId});

function setLoginMsg(t){ $('loginMsg').textContent = t || ""; }
function postJoin(players){
  $('login').style.display='none';
  $('app').style.display='grid';
  $('roomBadge').textContent = "Hold: " + roomId + (isHost ? " (V√¶rt)" : "");
  if (isHost) {
    $('hostCtl').style.display = 'block';
    $('roundCtl').style.display = 'block';
  }
  renderPlayers(players);
  setupCanvas();

  // fokus p√• g√¶t-felt
  setTimeout(()=>{ $('msg')?.focus(); }, 100);

  $('palette').addEventListener('click', e=>{
    const c = e.target.getAttribute('data-color');
    if(c){
      isErasing = false;
      currentColor = c;
      const ctx = $('canvas').getContext('2d');
      ctx.strokeStyle = currentColor;
    }
  });

  $('setRoundsBtn').onclick = ()=>{
    const r = parseInt($('roundsInput').value);
    if(r > 0){
      socket.emit('setRounds',{ roomId, rounds:r });
    }
  };

  // del / kopi√©r
  $('shareBtn').onclick = async ()=>{
    const url = addRoomToUrl(roomId);
    try{
      if(navigator.share){
        await navigator.share({ title:"Klassens Skribbl", text:"Join mit hold:", url });
      }else{
        await navigator.clipboard.writeText(url);
        flashMsg("Link kopieret!");
      }
    }catch{}
  };
  $('copyBtn').onclick = async ()=>{
    const url = addRoomToUrl(roomId);
    try{ await navigator.clipboard.writeText(url); flashMsg("Link kopieret!"); }catch{}
  };
}

function connect(onReady){
  myName = (($('name').value||"").trim());
  const code = (($('code').value||"").trim());
  const avatar = $('avatar').value;
  if(!myName || !code) return setLoginMsg("Udfyld navn og klassekode.");

  socket = io({ autoConnect:false, auth:{ name: myName, classCode: code } });
  socket = io({ autoConnect:false, auth:{ name: myName, classCode: code, avatar } });
  socket.connect();

  socket.on('connect_error', (e)=> setLoginMsg(e && e.message || "Forbindelsesfejl."));
  socket.on('playerList', renderPlayers);

  socket.on('turnInfo', ({drawerName})=>{
    canDraw=false;
    $('phase').textContent = drawerName + " v√¶lger et ord‚Ä¶";
    $('timer').textContent = '';
    clearInterval(drawTimerInt);
    clearInterval(chooseTimerInt);
  });

  socket.on('chooseWordFree', ({maxLen, chooseTime})=>{
    const modal = $('chooseModal');
     const fw = $('freeWord');
    const submit = $('submitWord');
    const cancel = $('cancelWord');

    if (fw) fw.value = "";

    submit.onclick = ()=>{
      const w = (fw.value||"").trim();
      if (!w) return;
      let clean = w.replace(/\s+/g, ' ').slice(0, maxLen || 20);
      socket.emit('wordChosen', {roomId, word: clean});
      modal.style.display='none';
    };
    cancel.onclick = ()=>{ modal.style.display='none'; };
    fw.onkeydown = (e)=>{ if(e.key === 'Enter'){ submit.onclick(); } };
    modal.style.display='flex';
    fw.focus();

    clearInterval(chooseTimerInt);
    let remaining = Math.round(chooseTime || 20);
    $('timer').textContent = "Tid til ordvalg: " + remaining + "s";
    chooseTimerInt = setInterval(()=>{
      remaining--;
      $('timer').textContent = "Tid til ordvalg: " + remaining + "s";
      if(remaining <= 0){
        clearInterval(chooseTimerInt);
        clearInterval(chooseTimerInt); chooseTimerInt = null;
        modal.style.display = 'none';   // luk modal
      }
    }, 1000);
  });

  socket.on('youDraw', ({word})=>{
    canDraw = true;
    $('phase').textContent = "Du tegner: " + word;
    // fallback: hvis drawTimer ikke er startet via roundStart (skulle den v√¶re), start en lokal
    if(!drawTimerInt){
      let remaining = 80;
      $('timer').textContent = "Tid tilbage: " + remaining + "s";
      drawTimerInt = setInterval(()=>{
        remaining--;
        $('timer').textContent = "Tid tilbage: " + remaining + "s";
     });

  socket.on('roundStart', ({drawerName, hint})=>{
    $('phase').textContent = drawerName + " tegner ‚Äì g√¶t i chatten! Ord: " + (hint || '');
    const cv=$('canvas'); cv.getContext('2d').clearRect(0,0,cv.width,cv.height);

    clearInterval(drawTimerInt); drawTimerInt=null;
    clearInterval(chooseTimerInt); chooseTimerInt=null;
    let remaining = 80;
    $('timer').textContent = "Tid tilbage: " + remaining + "s";
    drawTimerInt = setInterval(()=>{
      remaining--;
      $('timer').textContent = "Tid tilbage: " + remaining + "s";
      if(remaining <= 0){
        clearInterval(drawTimerInt); drawTimerInt=null;
      }
    }, 1000);
  });

  socket.on('roundEnd', ({reason, word})=>{
    canDraw=false;
    clearInterval(drawTimerInt); drawTimerInt=null;
    clearInterval(chooseTimerInt); chooseTimerInt=null;
    $('timer').textContent = '';
    $('phase').textContent = "Runden sluttede (" + reason + "). Ordet var: " + word;
    addChat("Ordet var: " + word);
  });

  socket.on('hintUpdate', ({hint})=>{
    const txt = $('phase').textContent;
    const idx = txt.indexOf("Ord:");
    if(idx >= 0){
      $('phase').textContent = txt.substring(0, idx + 4) + " " + hint;
    }
  });

  socket.on('chat', ({from, msg})=> addChat(from + ": " + msg));

  socket.on('gameOver', ({ podium, players })=>{
    const wrap = $('podiumList'); wrap.innerHTML = "";
    const classes = ['gold','silver','bronze'];
    (podium||[]).forEach((p,idx)=>{
      const div = document.createElement('div');
      div.className = 'pod ' + (classes[idx]||'');
      div.innerHTML = `<div style="font-size:20px;font-weight:800">${idx+1}. plads</div>
        <div style="font-size:18px">${p.name||'?'}</div>
        <div class="muted">Point: ${p.score||0}</div>`;
      wrap.appendChild(div);
    });
    $('podiumModal').style.display='flex';
  });
  });
  $('closePodium').onclick = ()=>{ $('podiumModal').style.display='none'; };

  socket.on('connect', ()=> { if (onReady) onReady(); });
}

// delbar URL: ?room=XXXX
function addRoomToUrl(rid){
  const u = new URL(window.location.href);
  u.searchParams.set('room', rid);
  return u.toString();
}
function fromUrlRoom(){
  const u = new URL(window.location.href);
  return (u.searchParams.get('room')||"").toUpperCase();
}
function updateShareUI(){
  $('shareBtn').style.display = 'inline-block';
  $('copyBtn').style.display = 'inline-block';
}
function flashMsg(t){
  const old = $('loginMsg').textContent;
  $('loginMsg').textContent = t;
  setTimeout(()=>{ $('loginMsg').textContent = old; }, 1200);
}

// auto-udfyld holdkode fra URL
window.addEventListener('DOMContentLoaded', ()=>{
  const r = fromUrlRoom();
  if(r){ $('roomIn').value = r; }
  // Enter til join/create i loginfelter
  $('name').addEventListener('keydown', e=>{ if(e.key==='Enter'){ $('btnCreate').click(); } });
  $('code').addEventListener('keydown', e=>{ if(e.key==='Enter'){ $('btnCreate').click(); } });
  $('roomIn').addEventListener('keydown', e=>{ if(e.key==='Enter'){ $('btnJoin').click(); } });
});
</script>

</body>
</html>


